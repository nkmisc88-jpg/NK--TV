name: DRM Link Converter

on:
  push:
    paths:
      - 'drm.txt'
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Run Conversion Script
        run: |
          python -c "
          import re
          import os

          INPUT_FILE = 'drm.txt'
          OUTPUT_FILE = 'converted_drm.txt'
          
          # 1. EXACT HEADERS FROM YOUR WORKING SNIPPET
          REAL_UA = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
          REAL_REF = 'https://starzplay.com/'

          print(f'Reading {INPUT_FILE}...')
          
          if os.path.exists(INPUT_FILE):
              with open(INPUT_FILE, 'r', encoding='utf-8') as f:
                  lines = f.readlines()
              
              output_lines = []
              
              # Buffer variables
              current_key = ''
              current_title = ''
              current_logo = ''
              
              count = 0

              for line in lines:
                  line = line.strip()
                  if not line: continue
                  
                  # --- A. FIND KEY (Anywhere in the line) ---
                  # We look for the 32-char hex string with a colon in the middle
                  if 'license_key=' in line:
                      parts = line.split('license_key=')
                      # Grab the key part (e.g., c540...:3071...)
                      raw_key = parts[1].split()[0].strip()
                      # Clean quotes
                      current_key = raw_key.replace('\"', '')

                  # --- B. FIND TITLE & LOGO ---
                  if 'group-title' in line or 'tvg-logo' in line or '#EXTINF' in line:
                      # Extract Logo
                      logo_match = re.search(r'tvg-logo=\"([^\"]*)\"', line)
                      if logo_match: current_logo = logo_match.group(1)
                      
                      # Extract Title (Text after the last comma)
                      last_comma = line.rfind(',')
                      if last_comma != -1:
                          title_part = line[last_comma+1:]
                          # If http link is on the same line, remove it from title
                          if 'http' in title_part:
                              title_part = title_part.split('http')[0]
                          current_title = title_part.strip().replace('\"', '')

                  # --- C. FIND URL (Starts with http) ---
                  url_match = re.search(r'(https?://[^\s|]+)', line)
                  if url_match:
                      # Get the pure URL without previous headers
                      url = url_match.group(1)
                      
                      if not current_title: 
                          current_title = f'Channel {count+1}'

                      # --- D. BUILD THE "KITCHEN SINK" HEADERS ---
                      # We add the key in THREE different formats to ensure compatibility
                      
                      headers = f'User-Agent={REAL_UA}&Referer={REAL_REF}'
                      
                      if current_key:
                          # 1. TiviMate / Standard format
                          headers += f'&clearkey={current_key}'
                          # 2. OTT Navigator specific format
                          headers += f'&drm_scheme=clearkey&drm_license_key={current_key}'
                          # 3. Kodi / Inputstream format (Just in case)
                          headers += f'&inputstream.adaptive.license_type=clearkey&inputstream.adaptive.license_key={current_key}'
                      
                      # Save to output list
                      output_lines.append(f'Title: {current_title}')
                      if current_logo:
                          output_lines.append(f'Logo: {current_logo}')
                      
                      final_link = f'{url}|{headers}'
                      output_lines.append(f'Link: {final_link}')
                      output_lines.append('') # Spacer
                      
                      print(f'--> Converted: {current_title}')
                      count += 1
                      
                      # Reset buffers
                      current_key = ''
                      current_title = ''
                      current_logo = ''

              if count > 0:
                  with open(OUTPUT_FILE, 'w', encoding='utf-8') as f:
                      f.write('\n'.join(output_lines))
                  print(f'SUCCESS: Saved {count} channels.')
              else:
                  open(OUTPUT_FILE, 'w').close()
                  print('WARNING: No links found.')
          else:
              print('ERROR: drm.txt not found')
          "

      - name: Commit Converted File
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git pull origin main
          git add converted_drm.txt
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update converted links" && git push)
