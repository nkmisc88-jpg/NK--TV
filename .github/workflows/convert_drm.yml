name: DRM Link Converter

on:
  push:
    paths:
      - 'drm.txt'
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Run Conversion Script
        run: |
          python -c "
          import re
          import os

          INPUT_FILE = 'drm.txt'
          OUTPUT_FILE = 'converted_drm.txt'
          
          # Headers matching your WORKING snippet
          REAL_UA = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
          REAL_REF = 'https://starzplay.com/'

          print(f'Reading {INPUT_FILE}...')
          
          if os.path.exists(INPUT_FILE):
              with open(INPUT_FILE, 'r', encoding='utf-8') as f:
                  lines = f.readlines()
              
              output_lines = []
              
              # Buffers
              current_key = ''
              current_title = ''
              current_logo = ''
              
              count = 0

              for line in lines:
                  line = line.strip()
                  if not line: continue
                  
                  # 1. SCAN FOR LICENSE KEY (Anywhere in the line)
                  if 'license_key=' in line:
                      parts = line.split('license_key=')
                      # Grab the part after =, stop at next space or end of line
                      potential_key = parts[1].split()[0].strip()
                      # Clean it if it has quotes
                      current_key = potential_key.replace('\"', '')

                  # 2. SCAN FOR TITLE & LOGO (Anywhere in the line)
                  if 'group-title' in line or 'tvg-logo' in line or '#EXTINF' in line:
                      # Extract Logo
                      logo_match = re.search(r'tvg-logo=\"([^\"]*)\"', line)
                      if logo_match: current_logo = logo_match.group(1)
                      
                      # Extract Title (Find the LAST comma in the line)
                      last_comma = line.rfind(',')
                      if last_comma != -1:
                          # Title is usually text after comma, BUT before the http link
                          # We'll split by http just to be safe
                          title_part = line[last_comma+1:]
                          if 'http' in title_part:
                              title_part = title_part.split('http')[0]
                          current_title = title_part.strip().replace('\"', '')

                  # 3. SCAN FOR URL (Anywhere in the line)
                  # We look for http/https string
                  url_match = re.search(r'(https?://[^\s|]+)', line)
                  if url_match:
                      url = url_match.group(1)
                      
                      # Safety: Default title
                      if not current_title: 
                          current_title = f'Channel {count+1}'

                      # --- BUILD THE MAGIC LINE ---
                      headers = f'User-Agent={REAL_UA}&Referer={REAL_REF}'
                      
                      if current_key:
                          headers += f'&clearkey={current_key}'
                      
                      output_lines.append(f'Title: {current_title}')
                      if current_logo:
                          output_lines.append(f'Logo: {current_logo}')
                      
                      final_link = f'{url}|{headers}'
                      output_lines.append(f'Link: {final_link}')
                      output_lines.append('') # Spacer
                      
                      print(f'--> Converted: {current_title}')
                      count += 1
                      
                      # Reset buffers after saving a link
                      current_key = ''
                      current_title = ''
                      current_logo = ''

              if count > 0:
                  with open(OUTPUT_FILE, 'w', encoding='utf-8') as f:
                      f.write('\n'.join(output_lines))
                  print(f'SUCCESS: Saved {count} channels.')
              else:
                  open(OUTPUT_FILE, 'w').close()
                  print('WARNING: No links found.')
          else:
              print('ERROR: drm.txt not found')
          "

      - name: Commit Converted File
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git pull origin main
          git add converted_drm.txt
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update converted links" && git push)
