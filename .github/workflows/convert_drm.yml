name: DRM Link Converter

on:
  push:
    paths:
      - 'drm.txt'
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Run Conversion Script
        run: |
          python -c "
          import re
          import os

          INPUT_FILE = 'drm.txt'
          OUTPUT_FILE = 'converted_drm.txt'
          DEFAULT_UA = 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36'
          DEFAULT_REF = 'https://starzplayarabia.com/'

          print(f'Reading {INPUT_FILE}...')
          
          if os.path.exists(INPUT_FILE):
              with open(INPUT_FILE, 'r', encoding='utf-8') as f:
                  lines = f.readlines()
              
              output_lines = []
              count = 0

              for line in lines:
                  line = line.strip()
                  if not line: continue
                  
                  # 1. FIND URL (Look for http/https)
                  url_match = re.search(r'(https?://\S+)', line)
                  if not url_match: 
                      continue # Skip lines without links
                  
                  url = url_match.group(1)
                  
                  # 2. FIND LICENSE KEY
                  key = ''
                  # Regex looks for 'license_key=' followed by hex characters and colons
                  key_match = re.search(r'license_key=([a-fA-F0-9:]+)', line)
                  if key_match:
                      key = key_match.group(1)

                  # 3. FIND LOGO
                  logo = ''
                  logo_match = re.search(r'tvg-logo=\"([^\"]*)\"', line)
                  if logo_match:
                      logo = logo_match.group(1)

                  # 4. FIND TITLE (Tricky part!)
                  # Logic: The title is usually text between the last comma and the URL
                  title = 'Unknown Channel'
                  try:
                      # Find where the URL starts
                      url_start = line.find(url)
                      # Take the text BEFORE the URL
                      text_before_url = line[:url_start].strip()
                      # Find the last comma in that text
                      last_comma_index = text_before_url.rfind(',')
                      
                      if last_comma_index != -1:
                          # The title is everything after that comma
                          title = text_before_url[last_comma_index+1:].strip()
                          # Clean up quotes if present
                          title = title.replace('\"', '')
                  except:
                      pass
                  
                  # 5. BUILD OUTPUT
                  headers = f'User-Agent={DEFAULT_UA}&Referer={DEFAULT_REF}'
                  if key:
                      headers += f'&clearkey={key}'
                  
                  output_lines.append(f'Title: {title}')
                  if logo:
                      output_lines.append(f'Logo: {logo}')
                  
                  # Combine Link | Headers
                  output_lines.append(f'Link: {url}|{headers}')
                  output_lines.append('') # Empty line for spacing
                  
                  count += 1
                  print(f'--> Converted: {title}')

              # SAVE FILE
              if count > 0:
                  with open(OUTPUT_FILE, 'w', encoding='utf-8') as f:
                      f.write('\n'.join(output_lines))
                  print(f'SUCCESS: Saved {count} channels to {OUTPUT_FILE}')
              else:
                  print('WARNING: No valid links found. Check if lines start with http or contain urls.')
                  # Create empty file
                  open(OUTPUT_FILE, 'w').close()
                  
          else:
              print('ERROR: drm.txt not found')
          "

      - name: Commit Converted File
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git pull origin main
          git add converted_drm.txt
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update converted links" && git push)
