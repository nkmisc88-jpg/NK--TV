name: Auto-Generate Playlist

on:
  schedule:
    - cron: '*/15 * * * *' # Runs every 15 mins
  workflow_dispatch:
  push:
    paths:
      - 'temp_channels.txt'

permissions:
  contents: write

jobs:
  build-playlist:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Requests
        run: pip install requests pytz

      - name: Run Generator Script
        run: |
          cat <<EOF > generate.py
          import requests
          import re
          import os
          from datetime import datetime, timedelta, timezone

          # --- CONFIGURATION ---
          OUTPUT_FILE = "index.html"
          TEMP_FILE = "temp_channels.txt"
          
          # Priority 1: ARUNJUNAN (Main Source)
          TV_SOURCES = [
              "https://raw.githubusercontent.com/Arunjunan20/My-IPTV/main/index.html",
              "https://raw.githubusercontent.com/tiger629/m3u/refs/heads/main/joker.m3u",
              "https://raw.githubusercontent.com/ForceGT/Discord-IPTV/master/playlist.m3u"
          ]

          EVENT_SOURCES = [
              ("FanCode", "https://raw.githubusercontent.com/byte-capsule/FanCode-Hls-Fetcher/main/Fancode_Live.m3u"),
              ("SonyLIV", "https://raw.githubusercontent.com/doctor-8trange/zyphora/refs/heads/main/data/sony.m3u"),
              ("Zee5 Live", "https://raw.githubusercontent.com/doctor-8trange/quarnex/refs/heads/main/data/zee5.m3u")
          ]

          YOUTUBE_SOURCE = "https://raw.githubusercontent.com/nkmisc88-jpg/my-youtube-live-playlist/refs/heads/main/playlist.m3u"

          CATEGORIES = {
              "Tamil": ["Sun TV HD", "Star Vijay HD", "Colors Tamil HD", "Zee Tamil HD", "KTV HD", "Sun Music HD", "Kalaignar TV", "Jaya TV HD", "Raj TV", "Adithya TV", "Thanthi One", "Sun life", "Polimer TV", "Vendhar TV", "Madhimugam TV", "MK Six", "D Tamil", "Jothi TV", "OM TV", "Puthu Yugam"],
              "Movies": ["Zee Thirai HD", "Vijay Super HD", "Vijay Takkar", "J Movies", "Raj Digital Plus", "Star Movies HD", "Star Movies Select HD"],
              "Music": ["Raj Musix", "Jaya Max", "Tunes 6"],
              "Entertainment": ["Zee Tamil HD APAC", "Colors Infinity HD", "Zee Café HD", "&Flix HD", "&Prive HD", "MTV HD", "Disney International HD", "Nick HD+"],
              "News": ["Sun News", "News7 Tamil", "Thanthi TV", "Raj News 24x7", "Tamil Janam", "Jaya Plus", "M Nadu", "News J"],
              "Sports": ["Star Sports 1 HD", "Star Sports 2 HD", "Star Sports 3", "Star Sports 1 Tamil HD", "Star Sports 2 Tamil HD", "Eurosport HD", "Jio Sports HD"],
              "Kids": ["Nick Tamil", "Sonic Tamil", "Pogo", "Cartoon Network", "CN HD+ Tamil", "Chutti TV", "Disney Channel", "Disney Junior", "Hungama", "Super Hungama", "Nick Jr", "Discovery Kids", "Sony Yay Hindi"],
              "Infotainment": ["History TV18 HD", "Discovery HD World", "National Geographic HD", "Nat Geo Wild HD", "Animal Planet HD World", "Discovery Tamil", "Sony BBC Earth HD", "Travelxp Tamil", "Zee Zest HD", "Jio Specials HD"]
          }

          # --- PARSER WITH "PIPE FIXER" ---
          def extract_and_fix(content):
              items = []
              # Split by #EXTINF to isolate blocks
              raw_blocks = re.split(r'(?=#EXTINF)', content)
              
              for block in raw_blocks:
                  if not block.strip(): continue
                  
                  # 1. Get Name
                  name_match = re.search(r'#EXTINF:.*,(.+)', block)
                  if not name_match: continue
                  name = name_match.group(1).strip()
                  
                  # 2. Get Logo
                  logo = ""
                  logo_match = re.search(r'tvg-logo="([^"]+)"', block)
                  if logo_match: logo = logo_match.group(1)
                  
                  # 3. Get URL (Last non-empty line)
                  lines = [l.strip() for l in block.splitlines() if l.strip()]
                  url = lines[-1]
                  if url.startswith("#"): continue # Skip if no URL found
                  
                  # 4. CRITICAL FIX: Extract User-Agent and append with pipe (|)
                  # Many players ignore #EXTVLCOPT but respect the pipe format
                  ua = ""
                  if "http-user-agent=" in block:
                      ua_match = re.search(r'http-user-agent=([^\s]+)', block)
                      if ua_match: ua = ua_match.group(1)
                  elif "User-Agent" in block: # Check #EXTHTTP
                      ua_match = re.search(r'"User-Agent"\s*:\s*"([^"]+)"', block)
                      if ua_match: ua = ua_match.group(1)
                  
                  # If we found a UA but it's not already piped, add it
                  if ua and "|User-Agent=" not in url:
                      url = f"{url}|User-Agent={ua}"
                  
                  # 5. Extract Cookie/Referer if needed (For Zee/Sony)
                  cookie = ""
                  if "cookie" in block and "http-user-agent" not in block:
                       cookie_match = re.search(r'"cookie"\s*:\s*"([^"]+)"', block)
                       if cookie_match: cookie = cookie_match.group(1)
                       
                  if cookie:
                      url = f"{url}|Cookie={cookie}"

                  items.append({
                      "name": name,
                      "logo": logo,
                      "url": url,
                      "raw_block": block # Keep original just in case
                  })
              return items

          def normalize(text):
              if not text: return ""
              return re.sub(r'[^a-z0-9]', '', text.lower())

          def get_ist_time():
              ist = timezone(timedelta(hours=5, minutes=30))
              return datetime.now(ist).strftime("%Y-%m-%d %H:%M:%S IST")

          # --- MAIN GENERATOR ---
          def main():
              final_lines = ["#EXTM3U x-tvg-url=\"http://botallen.live/epg.xml.gz\""]
              final_lines.append(f"# Playlist Updated: {get_ist_time()}")
              final_lines.append("")

              # 1. TEMP CHANNELS
              if os.path.exists(TEMP_FILE):
                  with open(TEMP_FILE, "r") as f:
                      for line in f:
                          parts = [p.strip() for p in line.split('|')]
                          if len(parts) >= 3:
                              name, logo, link = parts[0], parts[1], parts[2]
                              final_lines.append(f'#EXTINF:-1 group-title="Temporary" tvg-logo="{logo}", {name}')
                              final_lines.append(link)
                  final_lines.append("")

              # 2. YOUTUBE (Direct Copy)
              try:
                  yt_content = requests.get(YOUTUBE_SOURCE).text
                  yt_items = extract_and_fix(yt_content)
                  for item in yt_items:
                      final_lines.append(f'#EXTINF:-1 group-title="YouTube" tvg-logo="{item["logo"]}", {item["name"]}')
                      final_lines.append(item['url'])
              except: pass

              # 3. LIVE EVENTS
              for source_name, url in EVENT_SOURCES:
                  try:
                      content = requests.get(url).text
                      items = extract_and_fix(content)
                      for item in items:
                          clean_name = item["name"].replace("Live Event", "").strip()
                          final_lines.append(f'#EXTINF:-1 group-title="Live Events" tvg-logo="{item["logo"]}", {source_name}: {clean_name}')
                          final_lines.append(item['url'])
                  except: pass

              # 4. MAIN TV (Prioritized & Fixed)
              print(">>> Harvesting Main TV...")
              all_items = []
              
              for idx, url in enumerate(TV_SOURCES):
                  try:
                      content = requests.get(url).text
                      items = extract_and_fix(content)
                      for item in items: item['prio'] = idx
                      all_items.extend(items)
                  except: pass

              seen_channels = set()
              for cat, target_list in CATEGORIES.items():
                  for target in target_list:
                      if target.lower() in seen_channels: continue
                      
                      matches = [i for i in all_items if normalize(i['name']) == normalize(target)]
                      
                      if matches:
                          matches.sort(key=lambda x: x['prio'])
                          best = matches[0]
                          seen_channels.add(target.lower())
                          
                          # Write SIMPLE Entry (Player-friendly)
                          final_lines.append(f'#EXTINF:-1 group-title="{cat}" tvg-logo="{best["logo"]}", {target}')
                          final_lines.append(best['url'])

              # 5. WRITE
              with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
                  f.write("\n".join(final_lines))

          if __name__ == "__main__":
              main()
          EOF
          
          python generate.py

      - name: Commit & Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add index.html
          if git diff --cached --quiet; then
            echo "➡️ No changes detected"
            exit 0
          fi
          git commit -m "playlist update"
          git push origin main
