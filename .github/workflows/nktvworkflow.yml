name: Auto-Generate Playlist

on:
  schedule:
    - cron: '*/15 * * * *' # Runs every 15 mins
  workflow_dispatch:
  push:
    paths:
      - 'temp_channels.txt'

permissions:
  contents: write

jobs:
  build-playlist:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Requests
        run: pip install requests pytz

      - name: Run Generator Script
        run: |
          cat <<EOF > generate.py
          import requests
          import re
          import os
          from datetime import datetime, timedelta, timezone

          # --- CONFIGURATION ---
          OUTPUT_FILE = "index.html"
          TEMP_FILE = "temp_channels.txt"
          
          # Priority 1: ARUNJUNAN (We must CLONE these exactly)
          # Priority 2: TIGER/JOKER (Backups)
          TV_SOURCES = [
              "https://raw.githubusercontent.com/Arunjunan20/My-IPTV/main/index.html",
              "https://raw.githubusercontent.com/tiger629/m3u/refs/heads/main/joker.m3u",
              "https://raw.githubusercontent.com/ForceGT/Discord-IPTV/master/playlist.m3u"
          ]

          EVENT_SOURCES = [
              ("FanCode", "https://raw.githubusercontent.com/byte-capsule/FanCode-Hls-Fetcher/main/Fancode_Live.m3u"),
              ("SonyLIV", "https://raw.githubusercontent.com/doctor-8trange/zyphora/refs/heads/main/data/sony.m3u"),
              ("Zee5 Live", "https://raw.githubusercontent.com/doctor-8trange/quarnex/refs/heads/main/data/zee5.m3u")
          ]

          YOUTUBE_SOURCE = "https://raw.githubusercontent.com/nkmisc88-jpg/my-youtube-live-playlist/refs/heads/main/playlist.m3u"

          CATEGORIES = {
              "Tamil": ["Sun TV HD", "Star Vijay HD", "Colors Tamil HD", "Zee Tamil HD", "KTV HD", "Sun Music HD", "Kalaignar TV", "Jaya TV HD", "Raj TV", "Adithya TV", "Thanthi One", "Sun life", "Polimer TV", "Vendhar TV", "Madhimugam TV", "MK Six", "D Tamil", "Jothi TV", "OM TV", "Puthu Yugam"],
              "Movies": ["Zee Thirai HD", "Vijay Super HD", "Vijay Takkar", "J Movies", "Raj Digital Plus", "Star Movies HD", "Star Movies Select HD"],
              "Music": ["Raj Musix", "Jaya Max", "Tunes 6"],
              "Entertainment": ["Zee Tamil HD APAC", "Colors Infinity HD", "Zee Café HD", "&Flix HD", "&Prive HD", "MTV HD", "Disney International HD", "Nick HD+"],
              "News": ["Sun News", "News7 Tamil", "Thanthi TV", "Raj News 24x7", "Tamil Janam", "Jaya Plus", "M Nadu", "News J"],
              "Sports": ["Star Sports 1 HD", "Star Sports 2 HD", "Star Sports 3", "Star Sports 1 Tamil HD", "Star Sports 2 Tamil HD", "Eurosport HD", "Jio Sports HD"],
              "Kids": ["Nick Tamil", "Sonic Tamil", "Pogo", "Cartoon Network", "CN HD+ Tamil", "Chutti TV", "Disney Channel", "Disney Junior", "Hungama", "Super Hungama", "Nick Jr", "Discovery Kids", "Sony Yay Hindi"],
              "Infotainment": ["History TV18 HD", "Discovery HD World", "National Geographic HD", "Nat Geo Wild HD", "Animal Planet HD World", "Discovery Tamil", "Sony BBC Earth HD", "Travelxp Tamil", "Zee Zest HD", "Jio Specials HD"]
          }

          # --- BLOCK CLONER (The Fix) ---
          def extract_blocks(content):
              """
              Splits M3U into raw text blocks. 
              Each block contains the #EXTINF, all properties (#KODIPROP, etc), and the URL.
              """
              blocks = []
              current_block = []
              
              lines = content.splitlines()
              for line in lines:
                  line = line.strip()
                  if not line: continue
                  
                  if line.startswith("#EXTINF"):
                      if current_block:
                          blocks.append("\n".join(current_block))
                      current_block = [line]
                  elif line.startswith("#"):
                      current_block.append(line)
                  else:
                      # It's the URL, this ends the block
                      current_block.append(line)
                      blocks.append("\n".join(current_block))
                      current_block = []
              return blocks

          def normalize(text):
              if not text: return ""
              # Remove special chars and lowercase
              return re.sub(r'[^a-z0-9]', '', text.lower())

          def get_name_from_block(block):
              # Extract name from #EXTINF line
              match = re.search(r'#EXTINF:.*,(.+)$', block.split('\n')[0])
              if match:
                  return match.group(1).strip()
              return ""

          def get_ist_time():
              ist = timezone(timedelta(hours=5, minutes=30))
              return datetime.now(ist).strftime("%Y-%m-%d %H:%M:%S IST")

          # --- MAIN LOGIC ---
          def main():
              final_lines = ["#EXTM3U x-tvg-url=\"http://botallen.live/epg.xml.gz\""]
              final_lines.append(f"# Playlist Updated: {get_ist_time()}")
              final_lines.append("")

              # 1. TEMP CHANNELS
              if os.path.exists(TEMP_FILE):
                  with open(TEMP_FILE, "r") as f:
                      for line in f:
                          parts = [p.strip() for p in line.split('|')]
                          if len(parts) >= 3:
                              name, logo, link = parts[0], parts[1], parts[2]
                              final_lines.append(f'#EXTINF:-1 group-title="Temporary" tvg-logo="{logo}", {name}')
                              final_lines.append(link)
                  final_lines.append("")

              # 2. YOUTUBE
              try:
                  yt_content = requests.get(YOUTUBE_SOURCE).text
                  blocks = extract_blocks(yt_content)
                  for block in blocks:
                      # Force group title to YouTube
                      block = re.sub(r'group-title="[^"]*"', 'group-title="YouTube"', block)
                      final_lines.append(block)
              except: pass

              # 3. LIVE EVENTS
              for source_name, url in EVENT_SOURCES:
                  try:
                      content = requests.get(url).text
                      blocks = extract_blocks(content)
                      for block in blocks:
                          # Force group title and Prefix Name
                          block = re.sub(r'group-title="[^"]*"', 'group-title="Live Events"', block)
                          name = get_name_from_block(block)
                          if name:
                              block = block.replace(name, f"{source_name}: {name}")
                          final_lines.append(block)
                  except: pass

              # 4. MAIN TV (CLONING MODE)
              print(">>> Harvesting Channels (Cloning Mode)...")
              
              all_blocks = []
              # Download all blocks first
              for idx, url in enumerate(TV_SOURCES):
                  try:
                      content = requests.get(url).text
                      blocks = extract_blocks(content)
                      # Tag blocks with priority
                      for block in blocks:
                          all_blocks.append({'prio': idx, 'block': block, 'name': get_name_from_block(block)})
                  except: pass

              # Filter and Add
              seen_channels = set()
              for cat, target_list in CATEGORIES.items():
                  for target in target_list:
                      if target.lower() in seen_channels: continue
                      
                      # Find matches
                      matches = [b for b in all_blocks if normalize(b['name']) == normalize(target)]
                      
                      if matches:
                          matches.sort(key=lambda x: x['prio']) # Priority 0 = Arunjunan
                          best_block = matches[0]['block']
                          
                          # SAFE EDIT: Only change the group-title, touch nothing else
                          if 'group-title="' in best_block:
                              best_block = re.sub(r'group-title="[^"]*"', f'group-title="{cat}"', best_block)
                          else:
                              # Insert group title if missing
                              best_block = best_block.replace("#EXTINF:-1", f'#EXTINF:-1 group-title="{cat}"')
                              
                          seen_channels.add(target.lower())
                          final_lines.append(best_block)

              # 5. WRITE
              with open(OUTPUT_FILE, "w", encoding="utf-8") as f:
                  f.write("\n".join(final_lines))

          if __name__ == "__main__":
              main()
          EOF
          
          python generate.py

      - name: Commit & Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add index.html
          if git diff --cached --quiet; then
            echo "➡️ No changes detected"
            exit 0
          fi
          git commit -m "playlist update"
          git push origin main